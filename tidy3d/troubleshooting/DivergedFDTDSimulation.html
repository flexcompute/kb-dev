<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to Troubleshoot a Diverged FDTD Simulation | Tidy3D Knowledge Base</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" type="image/svg+xml" href="/tidy3d/favicon.svg">
    <link rel="icon" type="image/png" href="/tidy3d/favicon.png">
    <meta name="description" content="">
    <meta http-equiv="refresh" content="0; URL=&#39;https://www.flexcompute.com/tidy3d/learning-center/&#39;">
    
    <link rel="preload" href="/tidy3d/assets/css/0.styles.5009cd9f.css" as="style"><link rel="preload" href="/tidy3d/assets/js/app.fe21f11e.js" as="script"><link rel="preload" href="/tidy3d/assets/js/3.ade0f9cc.js" as="script"><link rel="preload" href="/tidy3d/assets/js/1.546a5d07.js" as="script"><link rel="preload" href="/tidy3d/assets/js/46.08a8f0f3.js" as="script"><link rel="prefetch" href="/tidy3d/assets/js/10.f342c2fa.js"><link rel="prefetch" href="/tidy3d/assets/js/11.ad53d62b.js"><link rel="prefetch" href="/tidy3d/assets/js/12.7f1905c5.js"><link rel="prefetch" href="/tidy3d/assets/js/13.619887a5.js"><link rel="prefetch" href="/tidy3d/assets/js/14.797965f2.js"><link rel="prefetch" href="/tidy3d/assets/js/15.bda9909a.js"><link rel="prefetch" href="/tidy3d/assets/js/16.97778170.js"><link rel="prefetch" href="/tidy3d/assets/js/17.115fe75b.js"><link rel="prefetch" href="/tidy3d/assets/js/18.9eb6b56e.js"><link rel="prefetch" href="/tidy3d/assets/js/19.7da12ffd.js"><link rel="prefetch" href="/tidy3d/assets/js/20.0558951c.js"><link rel="prefetch" href="/tidy3d/assets/js/21.dc8abbf7.js"><link rel="prefetch" href="/tidy3d/assets/js/22.38f2652d.js"><link rel="prefetch" href="/tidy3d/assets/js/23.1dfc0f20.js"><link rel="prefetch" href="/tidy3d/assets/js/24.e018f82f.js"><link rel="prefetch" href="/tidy3d/assets/js/25.3227c86b.js"><link rel="prefetch" href="/tidy3d/assets/js/26.c5d2e779.js"><link rel="prefetch" href="/tidy3d/assets/js/27.d3746771.js"><link rel="prefetch" href="/tidy3d/assets/js/28.159833ea.js"><link rel="prefetch" href="/tidy3d/assets/js/29.503ab3d1.js"><link rel="prefetch" href="/tidy3d/assets/js/30.805b32f7.js"><link rel="prefetch" href="/tidy3d/assets/js/31.5638764e.js"><link rel="prefetch" href="/tidy3d/assets/js/32.5cb3945e.js"><link rel="prefetch" href="/tidy3d/assets/js/33.eb8a8870.js"><link rel="prefetch" href="/tidy3d/assets/js/34.ad573405.js"><link rel="prefetch" href="/tidy3d/assets/js/35.05bcbd52.js"><link rel="prefetch" href="/tidy3d/assets/js/36.952eefe6.js"><link rel="prefetch" href="/tidy3d/assets/js/37.09268efa.js"><link rel="prefetch" href="/tidy3d/assets/js/38.0c84a6e5.js"><link rel="prefetch" href="/tidy3d/assets/js/39.a9f40bec.js"><link rel="prefetch" href="/tidy3d/assets/js/4.ce1eb115.js"><link rel="prefetch" href="/tidy3d/assets/js/40.e00ca0dc.js"><link rel="prefetch" href="/tidy3d/assets/js/41.2d00674d.js"><link rel="prefetch" href="/tidy3d/assets/js/42.e4f5c627.js"><link rel="prefetch" href="/tidy3d/assets/js/43.35960faf.js"><link rel="prefetch" href="/tidy3d/assets/js/44.338de1cf.js"><link rel="prefetch" href="/tidy3d/assets/js/45.05cd681b.js"><link rel="prefetch" href="/tidy3d/assets/js/5.2942fd17.js"><link rel="prefetch" href="/tidy3d/assets/js/6.5b151bda.js"><link rel="prefetch" href="/tidy3d/assets/js/7.09633a0a.js"><link rel="prefetch" href="/tidy3d/assets/js/8.0aec4d0f.js"><link rel="prefetch" href="/tidy3d/assets/js/9.fa32039d.js">
    <link rel="stylesheet" href="/tidy3d/assets/css/0.styles.5009cd9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tidy3d/" class="home-link router-link-active"><img src="/tidy3d/images/logo.svg" alt="Tidy3D Knowledge Base" class="logo"> <span class="site-name can-hide">Tidy3D Knowledge Base</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How to Troubleshoot a Diverged FDTD Simulation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#structures-inserted-into-pml-at-an-angle" class="sidebar-link">Structures Inserted into PML at an Angle</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#dispersive-material-into-pml" class="sidebar-link">Dispersive Material into PML</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#evanescent-field-leaks-into-pml" class="sidebar-link">Evanescent Field Leaks into PML</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#gain-medium-from-fitting" class="sidebar-link">Gain Medium from Fitting</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#courant-factor-is-too-large" class="sidebar-link">Courant Factor is Too Large</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#additional-notes-on-absorber" class="sidebar-link">Additional Notes on Absorber</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/tidy3d/troubleshooting/DivergedFDTDSimulation.html#contact-tidy3d-support" class="sidebar-link">Contact Tidy3D Support</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="how-to-troubleshoot-a-diverged-fdtd-simulation"><a href="#how-to-troubleshoot-a-diverged-fdtd-simulation" class="header-anchor">#</a> How to Troubleshoot a Diverged FDTD Simulation</h1> <p>Tidy3D uses the Finite-Difference Time-Domain (FDTD) method, which is a popular technique for rigorously solving Maxwell's equations. However, like all numerical methods, it can sometimes diverge if not properly set up. An FDTD simulation can diverge due to various reasons. In this article, we discuss common FDTD setting issues that could potentially lead to simulation divergence. If your simulation diverged, please follow this article and perform thorough troubleshooting, which will likely resolve the issue and ensure that your next FDTD run is stable.</p> <h2 id="structures-inserted-into-pml-at-an-angle"><a href="#structures-inserted-into-pml-at-an-angle" class="header-anchor">#</a> Structures Inserted into PML at an Angle</h2> <p>Perfectly matched layer (PML) is the most commonly used boundary condition in FDTD simulations to truncate a simulation domain and absorb outgoing radiation. However, many divergence issues are associated with the use of PML. One of the most common causes of a diverged simulation is structures inserted into PML at an angle. This is particularly common in simulations with photonic waveguides, where PML intersects a waveguide bend or a waveguide taper. To ensure numerical stability, you need to make sure that structures are translationally invariant into the PML.</p> <img src="/tidy3d/images/troubleshooting/diverged-fdtd-simulation.png"> <p>It is not always practically possible to have structures translationally invariant into PML. For example, in a waveguide-to-ring coupling simulation, part of the ring will have to intersect PML. In this case, using Tidy3D’s adiabatic absorber boundary condition instead of PML is a good remedy. The absorber functions similarly to PML such that it absorbs the outgoing radiation to mimic the infinite space. However, the absorber has a slightly higher reflection and requires a bit more computation than PML but it is numerically much more stable. For the demonstration, please refer to the waveguide-to-ring coupling tutorial.</p> <p>In principle, you can manually extend the bent waveguide or ring into PML in a translational invariant way. This could be effective in preventing divergence but the artificial kink will inevitably lead to undesired reflection. In general, we recommend using the absorber boundary rather than this approach.</p> <h2 id="dispersive-material-into-pml"><a href="#dispersive-material-into-pml" class="header-anchor">#</a> Dispersive Material into PML</h2> <p>Incorporating a dispersive material into PML can also cause simulation divergence in certain scenarios. If your simulation lacks any structures inserted into PML at an angle but includes dispersive material in PML, it is advisable to substitute nondispersive material for the dispersive material. Alternatively, if dispersion is necessary, switching PML to absorber can effectively address the issue.</p> <h2 id="evanescent-field-leaks-into-pml"><a href="#evanescent-field-leaks-into-pml" class="header-anchor">#</a> Evanescent Field Leaks into PML</h2> <p>PML can effectively absorb outgoing radiation with minimum reflection as if the radiation just propagates into the free space. However, it's important to keep in mind that PML only absorbs propagating fields. For evanescent fields, PML can act as an amplification medium and cause a simulation to diverge. In Tidy3D, a warning will appear if the distance between a structure is smaller than half of a wavelength to prevent evanescent fields from leaking into PML. In most cases, the evanescent field will naturally die off within half a wavelength, but in some instances, a larger distance may be required. One example is when using periodic or Bloch boundary conditions in two dimensions and PML in the last dimension only. In such simulations, there could be quasi-guided modes in the periodic directions which have very long evanescent tails in the PML direction. If a simulation diverges and you suspect that evanescent fields may be leaking into PML, simply increase the simulation domain size to avoid this issue.</p> <img src="/tidy3d/images/troubleshooting/diverged-fdtd-simulation1.png"> <p>Additionally, sources like PointDipole, UniformCurrentSource, or CustomFieldSource can inject evanescent fields, so it's important to leave enough space between them and PML.</p> <h2 id="gain-medium-from-fitting"><a href="#gain-medium-from-fitting" class="header-anchor">#</a> Gain Medium from Fitting</h2> <p>When defining a dispersive material using an external fitter or Tidy3D's regular fitter, it is crucial to ensure that the fit is passive. Although the material may appear passive within the simulation frequency range, the fitting process could result in a gain medium outside of the frequency range, leading to simulation divergence. To avoid this, Tidy3D offers a stable dispersive fitter that enforces passive fitting across all frequencies. It is highly recommended to use this fitter for dispersive medium fitting.</p> <h2 id="courant-factor-is-too-large"><a href="#courant-factor-is-too-large" class="header-anchor">#</a> Courant Factor is Too Large</h2> <p>When conducting FDTD simulations, it's important to satisfy the Courant factor condition. This condition, also known as the Courant number or Courant-Friedrichs-Lewy (CFL) condition, is a numerical requirement that relates the time step (Δt) to the spatial step (Δx), and sometimes to the wave propagation speed (c) in the system. The Courant factor can be determined by the formula: C = c * Δt / Δx. To ensure the stability of the numerical solution, the Courant factor must be equal to or less than 1, according to the CFL condition: C ≤ 1. By satisfying this condition, the simulation can accurately capture the wave propagation in the system, as information cannot travel further than one spatial step in one time step. Violating the CFL condition can cause the simulation to diverge and become unstable. Therefore, it's crucial to choose appropriate time and spatial step sizes for any FDTD simulation.</p> <p>Tidy3D uses a default Courant factor of 0.99. When a dispersive material with <code>eps_inf &lt; 1</code> is used, the Courant factor will be automatically adjusted to be smaller than <code>sqrt(eps_inf)</code>to ensure stability. If your simulation still diverges despite addressing any other issues discussed above, reducing the Courant factor may help.</p> <h2 id="additional-notes-on-absorber"><a href="#additional-notes-on-absorber" class="header-anchor">#</a> Additional Notes on Absorber</h2> <p>As discussed above, using absorber boundary is often a good remedy to resolve divergence issues related to PML. The adiabatic absorber is a multilayer system with gradually increasing conductivity. As briefly discussed above, the absorber usually has a larger undesired reflection compared to PML. In practice, this small difference rarely matters, but is important to understand for simulations that require high accuracy. There are two possible sources for the reflection from absorbers. The first, and more common one, is that the ramping up of the conductivity is not sufficiently slow, which can be remedied by increasing the number of absorber layers (40 by default). The second one is that the absorption is not high enough, such that the light reaches the PEC boundary at the end of the Absorber, travels back through it, and is still not fully attenuated before re-entering the simulation region. If this is the case, increasing the maximum conductivity (see the API reference) can help. In both cases, changing the order of the scaling of the conductivity (sigma_order) can also have an effect, but this is a more advanced setting that we typically do not recommend modifying.</p> <h2 id="contact-tidy3d-support"><a href="#contact-tidy3d-support" class="header-anchor">#</a> Contact Tidy3D Support</h2> <p>If the solutions provided in this article did not resolve your simulation issues, please contact <a href="https://www.flexcompute.com/tidy3d/technical-support/?site=kb&amp;_gl=1*1i6q8q0*_ga*MTg1NzUzODgyOS4xNjg1MDgyNDQz*_ga_VB7XZB03TL*MTY5MDg2NDAxOC4zNC4xLjE2OTA4NjQzODAuNjAuMC4w" target="_blank" rel="noopener noreferrer">Tidy3D Support<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Our experienced support engineers will assist you in resolving the problems with your simulation settings.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/tidy3d/assets/js/app.fe21f11e.js" defer></script><script src="/tidy3d/assets/js/3.ade0f9cc.js" defer></script><script src="/tidy3d/assets/js/1.546a5d07.js" defer></script><script src="/tidy3d/assets/js/46.08a8f0f3.js" defer></script>
  </body>
</html>
